open! Core
module Report = Bonsai_test.Computation_report
module Perf_configs = Bonsai_test_shared_for_testing_bonsai.Perf_configs

module%test [@name "list"] _ = struct
  let%expect_test "Startup" =
    Report.Startup.run_and_print_compare
      (module Perf_configs.Dynamic_num)
      Perf_configs.Dynamic_num.startup_inputs
      Perf_configs.Dynamic_num.all;
    [%expect
      {|
      ======= Startup Incr Node Stats =======
      ┌────────────────────────┬────────────┬────────────┬─────────────┬───────────────┐
      │                        │ max_height │ node_count │ max_node_id │ nodes_created │
      ├────────────────────────┼────────────┼────────────┼─────────────┼───────────────┤
      │ let%arr: 10            │  1         │      4     │       6     │       5       │
      │ bonsai.Map.map: 10     │  2         │      5     │       7     │       6       │
      │ assoc_simple: 10       │  2         │      5     │       7     │       6       │
      │ assoc: 10              │ 13         │     71     │     113     │     114       │
      │ let%arr: 1000          │  1         │      4     │       6     │       5       │
      │ bonsai.Map.map: 1000   │  2         │      5     │       7     │       6       │
      │ assoc_simple: 1000     │  2         │      5     │       7     │       6       │
      │ assoc: 1000            │ 13         │   6011     │   10013     │   10014       │
      │ let%arr: 100000        │  1         │      4     │       6     │       5       │
      │ bonsai.Map.map: 100000 │  2         │      5     │       7     │       6       │
      │ assoc_simple: 100000   │  2         │      5     │       7     │       6       │
      │ assoc: 100000          │ 13         │ 600011     │ 1000013     │ 1000014       │
      └────────────────────────┴────────────┴────────────┴─────────────┴───────────────┘

      ======= Startup Incr Annotated Node Counts =======
      ┌───────────────────┬───────┬────────┬────────┬───────────┬────────────┬────────┬────────────┬───────────┬───────────┬───────────┬───────────┬─────────────┬───────────┬──────┬────────────────────────┐
      │                   │ input │ value  │ result │ lifecycle │ empty_life │ model  │ model_and_ │ switch_mo │ assoc_key │ assoc_inp │ assoc_res │ assoc_lifec │ assoc_inp │ path │ lifecycle_apply_action │
      │                   │       │        │        │           │ cycle      │        │ input      │ del       │           │ ut        │ ults      │ ycles       │ uts       │      │ _pair                  │
      ├───────────────────┼───────┼────────┼────────┼───────────┼────────────┼────────┼────────────┼───────────┼───────────┼───────────┼───────────┼─────────────┼───────────┼──────┼────────────────────────┤
      │ let%arr: 10       │ 0     │      1 │      1 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ bonsai.Map.map:   │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 10                │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc_simple: 10  │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ assoc: 10         │ 0     │     32 │     73 │ 0         │     11     │     10 │     10     │ 0         │     10    │     10    │ 1         │ 1           │ 1         │ 0    │ 0                      │
      │ let%arr: 1000     │ 0     │      1 │      1 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ bonsai.Map.map:   │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 1000              │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc_simple:     │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 1000              │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc: 1000       │ 0     │   3002 │   7003 │ 0         │   1001     │   1000 │   1000     │ 0         │   1000    │   1000    │ 1         │ 1           │ 1         │ 0    │ 0                      │
      │ let%arr: 100000   │ 0     │      1 │      1 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ bonsai.Map.map:   │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 100000            │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc_simple:     │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 100000            │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc: 100000     │ 0     │ 300002 │ 700003 │ 0         │ 100001     │ 100000 │ 100000     │ 0         │ 100000    │ 100000    │ 1         │ 1           │ 1         │ 0    │ 0                      │
      └───────────────────┴───────┴────────┴────────┴───────────┴────────────┴────────┴────────────┴───────────┴───────────┴───────────┴───────────┴─────────────┴───────────┴──────┴────────────────────────┘

      ======= Bonsai Computation Nodes =======
      ┌─────────────┬────────┬────────┬───────┬───────┬────────┬────────┬─────┬───────┬───────┬───────┬────────┬────────┬────────┬────────┬────────┬──────┬──────────┬──────┬────────┬────────┬──────────────┐
      │             │ return │ leaf01 │ leaf1 │ leaf0 │ leaf_i │ model_ │ sub │ store │ fetch │ assoc │ assoc_ │ assoc_ │ switch │ fix_de │ fix_re │ wrap │ with_mod │ path │ lifecy │ identi │ monitor_free │
      │             │        │        │       │       │ ncr    │ cutoff │     │       │       │       │ on     │ simpl  │        │ fine   │ curse  │      │ el_reset │      │ cle    │ ty     │ _variables   │
      │             │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │ ter      │      │        │        │              │
      ├─────────────┼────────┼────────┼───────┼───────┼────────┼────────┼─────┼───────┼───────┼───────┼────────┼────────┼────────┼────────┼────────┼──────┼──────────┼──────┼────────┼────────┼──────────────┤
      │ let%arr: 10 │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ bonsai.Map. │ 0      │ 0      │ 0     │ 0     │ 2      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ map: 10     │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ assoc_simpl │ 0      │ 0      │ 0     │ 0     │ 1      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 1      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ e: 10       │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ assoc: 10   │ 3      │ 0      │ 0     │ 1     │ 1      │ 0      │ 4   │ 0     │ 0     │ 1     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ let%arr:    │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ 1000        │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ bonsai.Map. │ 0      │ 0      │ 0     │ 0     │ 2      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ map: 1000   │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ assoc_simpl │ 0      │ 0      │ 0     │ 0     │ 1      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 1      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ e: 1000     │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ assoc: 1000 │ 3      │ 0      │ 0     │ 1     │ 1      │ 0      │ 4   │ 0     │ 0     │ 1     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ let%arr:    │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ 100000      │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ bonsai.Map. │ 0      │ 0      │ 0     │ 0     │ 2      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ map: 100000 │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ assoc_simpl │ 0      │ 0      │ 0     │ 0     │ 1      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 1      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ e: 100000   │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      │ assoc:      │ 3      │ 0      │ 0     │ 1     │ 1      │ 0      │ 4   │ 0     │ 0     │ 1     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0        │ 0    │ 0      │ 0      │ 0            │
      │ 100000      │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │          │      │        │        │              │
      └─────────────┴────────┴────────┴───────┴───────┴────────┴────────┴─────┴───────┴───────┴───────┴────────┴────────┴────────┴────────┴────────┴──────┴──────────┴──────┴────────┴────────┴──────────────┘

      ======= Bonsai Value Nodes =======
      ┌────────────────────────┬──────────┬────────────┬──────┬───────┬────────┬──────┐
      │                        │ constant │ exception_ │ incr │ named │ cutoff │ mapn │
      ├────────────────────────┼──────────┼────────────┼──────┼───────┼────────┼──────┤
      │ let%arr: 10            │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ bonsai.Map.map: 10     │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc_simple: 10       │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc: 10              │ 0        │ 0          │ 1    │ 5     │ 0      │ 3    │
      │ let%arr: 1000          │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ bonsai.Map.map: 1000   │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc_simple: 1000     │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc: 1000            │ 0        │ 0          │ 1    │ 5     │ 0      │ 3    │
      │ let%arr: 100000        │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ bonsai.Map.map: 100000 │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc_simple: 100000   │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc: 100000          │ 0        │ 0          │ 1    │ 5     │ 0      │ 3    │
      └────────────────────────┴──────────┴────────────┴──────┴───────┴────────┴──────┘
      |}]
  ;;

  let%expect_test "Interaction" =
    Report.Interaction.run_and_print_compare
      (module Perf_configs.Dynamic_num)
      Perf_configs.Dynamic_num.scenarios
      Perf_configs.Dynamic_num.all;
    [%expect
      {|
      ======= Max Height =======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬───────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼───────┤
      │ 10, (1/5) updated 5 times      │ 1       │ 2              │ 2            │ 13    │
      │ 10, (1/10) updated 5 times     │ 1       │ 2              │ 2            │ 13    │
      │ 10, (1/50) updated 5 times     │ 1       │ 2              │ 2            │ 13    │
      │ 1000, (1/5) updated 5 times    │ 1       │ 2              │ 2            │ 13    │
      │ 1000, (1/10) updated 5 times   │ 1       │ 2              │ 2            │ 13    │
      │ 1000, (1/50) updated 5 times   │ 1       │ 2              │ 2            │ 13    │
      │ 100000, (1/5) updated 5 times  │ 1       │ 2              │ 2            │ 13    │
      │ 100000, (1/10) updated 5 times │ 1       │ 2              │ 2            │ 13    │
      │ 100000, (1/50) updated 5 times │ 1       │ 2              │ 2            │ 13    │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴───────┘

      ======= Node Count =======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬────────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc  │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼────────┤
      │ 10, (1/5) updated 5 times      │ 4       │ 5              │ 5            │     71 │
      │ 10, (1/10) updated 5 times     │ 4       │ 5              │ 5            │     71 │
      │ 10, (1/50) updated 5 times     │ 4       │ 5              │ 5            │     71 │
      │ 1000, (1/5) updated 5 times    │ 4       │ 5              │ 5            │   6011 │
      │ 1000, (1/10) updated 5 times   │ 4       │ 5              │ 5            │   6011 │
      │ 1000, (1/50) updated 5 times   │ 4       │ 5              │ 5            │   6011 │
      │ 100000, (1/5) updated 5 times  │ 4       │ 5              │ 5            │ 600011 │
      │ 100000, (1/10) updated 5 times │ 4       │ 5              │ 5            │ 600011 │
      │ 100000, (1/50) updated 5 times │ 4       │ 5              │ 5            │ 600011 │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴────────┘

      ======= Max Node ID =======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬─────────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc   │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼─────────┤
      │ 10, (1/5) updated 5 times      │ 6       │ 7              │ 7            │     113 │
      │ 10, (1/10) updated 5 times     │ 6       │ 7              │ 7            │     113 │
      │ 10, (1/50) updated 5 times     │ 6       │ 7              │ 7            │     113 │
      │ 1000, (1/5) updated 5 times    │ 6       │ 7              │ 7            │   10013 │
      │ 1000, (1/10) updated 5 times   │ 6       │ 7              │ 7            │   10013 │
      │ 1000, (1/50) updated 5 times   │ 6       │ 7              │ 7            │   10013 │
      │ 100000, (1/5) updated 5 times  │ 6       │ 7              │ 7            │ 1000013 │
      │ 100000, (1/10) updated 5 times │ 6       │ 7              │ 7            │ 1000013 │
      │ 100000, (1/50) updated 5 times │ 6       │ 7              │ 7            │ 1000013 │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴─────────┘

      ======= Nodes Created =======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬───────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼───────┤
      │ 10, (1/5) updated 5 times      │ 0       │ 0              │ 0            │ 0     │
      │ 10, (1/10) updated 5 times     │ 0       │ 0              │ 0            │ 0     │
      │ 10, (1/50) updated 5 times     │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/5) updated 5 times    │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/10) updated 5 times   │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/50) updated 5 times   │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/5) updated 5 times  │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/10) updated 5 times │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/50) updated 5 times │ 0       │ 0              │ 0            │ 0     │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴───────┘
      |}]
  ;;
end

module%test [@name "switch"] _ = struct
  let%expect_test "Startup" =
    Report.Startup.run_and_print_compare
      (module Perf_configs.Switch)
      Perf_configs.Switch.startup_inputs
      Perf_configs.Switch.all;
    [%expect
      {|
      ======= Startup Incr Node Stats =======
      ┌────────────────────────────────┬────────────┬────────────┬─────────────┬───────────────┐
      │                                │ max_height │ node_count │ max_node_id │ nodes_created │
      ├────────────────────────────────┼────────────┼────────────┼─────────────┼───────────────┤
      │ arr+match: Start true          │ 4          │ 11         │ 14          │ 13            │
      │ arr+match (state): Start true  │ 1          │  4         │  6          │  5            │
      │ match%sub: Start true          │ 6          │ 13         │ 22          │ 21            │
      │ match%sub (state): Start true  │ 6          │ 10         │ 20          │ 19            │
      │ arr+match: Start false         │ 4          │ 11         │ 14          │ 13            │
      │ arr+match (state): Start false │ 1          │  4         │  6          │  5            │
      │ match%sub: Start false         │ 6          │ 13         │ 22          │ 21            │
      │ match%sub (state): Start false │ 6          │ 10         │ 20          │ 19            │
      └────────────────────────────────┴────────────┴────────────┴─────────────┴───────────────┘

      ======= Startup Incr Annotated Node Counts =======
      ┌─────────────────────────┬───────┬───────┬────────┬───────────┬───────────┬───────┬───────────┬───────────┬───────────┬───────────┬───────────┬────────────┬───────────┬──────┬───────────────────────┐
      │                         │ input │ value │ result │ lifecycle │ empty_lif │ model │ model_and │ switch_mo │ assoc_key │ assoc_inp │ assoc_res │ assoc_life │ assoc_inp │ path │ lifecycle_apply_actio │
      │                         │       │       │        │           │ ecycle    │       │ _input    │ del       │           │ ut        │ ults      │ cycles     │ uts       │      │ n_pair                │
      ├─────────────────────────┼───────┼───────┼────────┼───────────┼───────────┼───────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼───────────┼──────┼───────────────────────┤
      │ arr+match: Start true   │ 0     │ 5     │ 13     │ 0         │ 1         │ 3     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ arr+match (state):      │ 0     │ 1     │  1     │ 0         │ 1         │ 0     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ Start true              │       │       │        │           │           │       │           │           │           │           │           │            │           │      │                       │
      │ match%sub: Start true   │ 0     │ 5     │ 10     │ 0         │ 2         │ 1     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ match%sub (state):      │ 0     │ 3     │  4     │ 0         │ 2         │ 0     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ Start true              │       │       │        │           │           │       │           │           │           │           │           │            │           │      │                       │
      │ arr+match: Start false  │ 0     │ 5     │ 13     │ 0         │ 1         │ 3     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ arr+match (state):      │ 0     │ 1     │  1     │ 0         │ 1         │ 0     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ Start false             │       │       │        │           │           │       │           │           │           │           │           │            │           │      │                       │
      │ match%sub: Start false  │ 0     │ 5     │ 10     │ 0         │ 2         │ 1     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ match%sub (state):      │ 0     │ 3     │  4     │ 0         │ 2         │ 0     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0          │ 0         │ 0    │ 0                     │
      │ Start false             │       │       │        │           │           │       │           │           │           │           │           │            │           │      │                       │
      └─────────────────────────┴───────┴───────┴────────┴───────────┴───────────┴───────┴───────────┴───────────┴───────────┴───────────┴───────────┴────────────┴───────────┴──────┴───────────────────────┘

      ======= Bonsai Computation Nodes =======
      ┌──────────────────┬────────┬────────┬───────┬───────┬────────┬────────┬─────┬───────┬───────┬───────┬────────┬────────┬────────┬────────┬────────┬──────┬────────┬──────┬────────┬────────┬───────────┐
      │                  │ return │ leaf01 │ leaf1 │ leaf0 │ leaf_i │ model_ │ sub │ store │ fetch │ assoc │ assoc_ │ assoc_ │ switch │ fix_de │ fix_re │ wrap │ with_m │ path │ lifecy │ identi │ monitor_f │
      │                  │        │        │       │       │ ncr    │ cutoff │     │       │       │       │ on     │ simpl  │        │ fine   │ curse  │      │ odel_r │      │ cle    │ ty     │ ree_varia │
      │                  │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │ esette │      │        │        │ bles      │
      │                  │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │ r      │      │        │        │           │
      ├──────────────────┼────────┼────────┼───────┼───────┼────────┼────────┼─────┼───────┼───────┼───────┼────────┼────────┼────────┼────────┼────────┼──────┼────────┼──────┼────────┼────────┼───────────┤
      │ arr+match:       │ 5      │ 0      │ 0     │ 2     │ 0      │ 0      │ 6   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ Start true       │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ arr+match        │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ (state): Start   │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ true             │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ match%sub:       │ 7      │ 0      │ 0     │ 2     │ 0      │ 0      │ 7   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ Start true       │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ match%sub        │ 3      │ 0      │ 0     │ 0     │ 0      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ (state): Start   │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ true             │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ arr+match:       │ 5      │ 0      │ 0     │ 2     │ 0      │ 0      │ 6   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ Start false      │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ arr+match        │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ (state): Start   │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ false            │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ match%sub:       │ 7      │ 0      │ 0     │ 2     │ 0      │ 0      │ 7   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ Start false      │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ match%sub        │ 3      │ 0      │ 0     │ 0     │ 0      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0         │
      │ (state): Start   │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      │ false            │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │           │
      └──────────────────┴────────┴────────┴───────┴───────┴────────┴────────┴─────┴───────┴───────┴───────┴────────┴────────┴────────┴────────┴────────┴──────┴────────┴──────┴────────┴────────┴───────────┘

      ======= Bonsai Value Nodes =======
      ┌────────────────────────────────┬──────────┬────────────┬──────┬───────┬────────┬──────┐
      │                                │ constant │ exception_ │ incr │ named │ cutoff │ mapn │
      ├────────────────────────────────┼──────────┼────────────┼──────┼───────┼────────┼──────┤
      │ arr+match: Start true          │ 0        │ 0          │ 1    │ 6     │ 0      │ 5    │
      │ arr+match (state): Start true  │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ match%sub: Start true          │ 0        │ 0          │ 1    │ 7     │ 0      │ 5    │
      │ match%sub (state): Start true  │ 2        │ 0          │ 1    │ 1     │ 0      │ 1    │
      │ arr+match: Start false         │ 0        │ 0          │ 1    │ 6     │ 0      │ 5    │
      │ arr+match (state): Start false │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ match%sub: Start false         │ 0        │ 0          │ 1    │ 7     │ 0      │ 5    │
      │ match%sub (state): Start false │ 2        │ 0          │ 1    │ 1     │ 0      │ 1    │
      └────────────────────────────────┴──────────┴────────────┴──────┴───────┴────────┴──────┘
      |}]
  ;;

  let%expect_test "Interaction" =
    Report.Interaction.run_and_print_compare
      (module Perf_configs.Switch)
      Perf_configs.Switch.scenarios
      Perf_configs.Switch.all;
    [%expect
      {|
      ======= Max Height =======
      ┌───────────────────────────────┬───────────┬───────────────────┬───────────┬───────────────────┐
      │                               │ arr+match │ arr+match (state) │ match%sub │ match%sub (state) │
      ├───────────────────────────────┼───────────┼───────────────────┼───────────┼───────────────────┤
      │ Start false, switch 1 times   │ 4         │ 1                 │ 6         │ 6                 │
      │ Start true, switch 1 times    │ 4         │ 1                 │ 6         │ 6                 │
      │ Start false, switch 5 times   │ 4         │ 1                 │ 6         │ 6                 │
      │ Start true, switch 5 times    │ 4         │ 1                 │ 6         │ 6                 │
      │ Start false, switch 10 times  │ 4         │ 1                 │ 6         │ 6                 │
      │ Start true, switch 10 times   │ 4         │ 1                 │ 6         │ 6                 │
      │ Start false, switch 100 times │ 4         │ 1                 │ 6         │ 6                 │
      │ Start true, switch 100 times  │ 4         │ 1                 │ 6         │ 6                 │
      └───────────────────────────────┴───────────┴───────────────────┴───────────┴───────────────────┘

      ======= Node Count =======
      ┌───────────────────────────────┬───────────┬───────────────────┬───────────┬───────────────────┐
      │                               │ arr+match │ arr+match (state) │ match%sub │ match%sub (state) │
      ├───────────────────────────────┼───────────┼───────────────────┼───────────┼───────────────────┤
      │ Start false, switch 1 times   │ 11        │ 4                 │ 13        │ 10                │
      │ Start true, switch 1 times    │ 11        │ 4                 │ 13        │ 10                │
      │ Start false, switch 5 times   │ 11        │ 4                 │ 13        │ 10                │
      │ Start true, switch 5 times    │ 11        │ 4                 │ 13        │ 10                │
      │ Start false, switch 10 times  │ 11        │ 4                 │ 13        │ 10                │
      │ Start true, switch 10 times   │ 11        │ 4                 │ 13        │ 10                │
      │ Start false, switch 100 times │ 11        │ 4                 │ 13        │ 10                │
      │ Start true, switch 100 times  │ 11        │ 4                 │ 13        │ 10                │
      └───────────────────────────────┴───────────┴───────────────────┴───────────┴───────────────────┘

      ======= Max Node ID =======
      ┌───────────────────────────────┬───────────┬───────────────────┬───────────┬───────────────────┐
      │                               │ arr+match │ arr+match (state) │ match%sub │ match%sub (state) │
      ├───────────────────────────────┼───────────┼───────────────────┼───────────┼───────────────────┤
      │ Start false, switch 1 times   │ 14        │ 6                 │  22       │  20               │
      │ Start true, switch 1 times    │ 14        │ 6                 │  22       │  20               │
      │ Start false, switch 5 times   │ 14        │ 6                 │  54       │  44               │
      │ Start true, switch 5 times    │ 14        │ 6                 │  54       │  44               │
      │ Start false, switch 10 times  │ 14        │ 6                 │  86       │  68               │
      │ Start true, switch 10 times   │ 14        │ 6                 │  86       │  68               │
      │ Start false, switch 100 times │ 14        │ 6                 │ 806       │ 608               │
      │ Start true, switch 100 times  │ 14        │ 6                 │ 806       │ 608               │
      └───────────────────────────────┴───────────┴───────────────────┴───────────┴───────────────────┘

      ======= Nodes Created =======
      ┌───────────────────────────────┬───────────┬───────────────────┬───────────┬───────────────────┐
      │                               │ arr+match │ arr+match (state) │ match%sub │ match%sub (state) │
      ├───────────────────────────────┼───────────┼───────────────────┼───────────┼───────────────────┤
      │ Start false, switch 1 times   │ 0         │ 0                 │   0       │   0               │
      │ Start true, switch 1 times    │ 0         │ 0                 │   0       │   0               │
      │ Start false, switch 5 times   │ 0         │ 0                 │  32       │  24               │
      │ Start true, switch 5 times    │ 0         │ 0                 │  32       │  24               │
      │ Start false, switch 10 times  │ 0         │ 0                 │  64       │  48               │
      │ Start true, switch 10 times   │ 0         │ 0                 │  64       │  48               │
      │ Start false, switch 100 times │ 0         │ 0                 │ 784       │ 588               │
      │ Start true, switch 100 times  │ 0         │ 0                 │ 784       │ 588               │
      └───────────────────────────────┴───────────┴───────────────────┴───────────┴───────────────────┘
      |}]
  ;;
end
